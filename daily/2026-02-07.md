# AIOpt Daily — 2026-02-07

## Tracker (WBS v0.2)
Format: `id | title | status | owner | started_at | last_proof_at | next_action | proof_link`

- T0 | TRIAGE / BASELINE (repo 상태 파악) | IN_PROGRESS | openclaw | 2026-02-07 18:10 KST | 2026-02-07 18:10 KST | Write baseline notes + explain scan flow | logs:daily/2026-02-07.md#t0
- T1 | CLI: install/doctor 명령 구현 | TODO | openclaw | - | - | After T0: implement install/doctor + file scaffolding | -
- T2 | Wrapper(guard) 구현 | TODO | openclaw | - | - | After T1: implement wrapper logging/routing/retry/caps | -
- T3 | scan: 해결책 생성기 업그레이드 | TODO | openclaw | - | - | After T2: report.md/report.json + patches 생성 | -
- T4 | Savings Simulator 리팩터 | TODO | openclaw | - | - | After T3: before/after caps + confidence | -
- T5 | 바이브코더 데모(5분 체험) 문서/스크립트 | TODO | openclaw | - | - | After T4: aiopt/README.md + reproduction steps | -

---

## [T0] TRIAGE / BASELINE
### Current repo
- Repo: https://github.com/tkddlr0716-collab/aiopt
- npm: https://www.npmjs.com/package/aiopt (published: 0.0.1)

### Folder tree (maxdepth=2, important files)
- `.github/workflows/ci.yml` (CI smoke)
- `dist/cli.js` (built CLI entry)
- `src/cli.ts` (commander commands)
- `src/scan.ts` (analysis + savings + policy generator)
- `src/cost.ts` (rate table lookup + per-event cost)
- `rates/rate_table.json` (subset table + estimated fallbacks)
- `samples/sample_usage.jsonl` (5-line sample)

### Current CLI commands
From `node dist/cli.js --help`:
- `aiopt init`
- `aiopt scan --input <path> --out <dir>`
- `aiopt policy --input <path> --out <dir>`

### Current outputs (scan)
Running:
- `node dist/cli.js scan --input ./aiopt-input/usage.jsonl`

Produces:
- `./aiopt-output/analysis.json`
- `./aiopt-output/report.txt`
- `./aiopt-output/cost-policy.json`

Sample report.txt (verbatim):
- 총비용: $0.23
- 절감 가능 금액(Estimated): $0.21
- 근거:
  - 모델 라우팅 절감(추정): $0.07
  - 컨텍스트 감축(추정): $0.02 (상위 20% input에 25% 감축 가정)
  - 재시도/오류 낭비: $0.13 (retries 기반)

### Why scan output is “숫자 3줄” + calculation flow
- `scan.ts` currently computes 3 savings levers and prints them as 3 lines in `report.txt`:
  1) **Routing savings (rule-based)**: if `feature_tag` in {summarize,classify,translate}, compare current model cost vs cheapest known model within the same provider. Unknown models are excluded from routing.
  2) **Context reduction estimate (deterministic)**: take top 20% events by `input_tokens`, assume 25% input reduction, save = reduced_tokens * input_rate.
  3) **Retry waste**: `retries>=1` → wasted = base_cost_per_call * retries (currently not trace_id-based).
- Total cost is sum of per-event cost (either `billed_cost` if present, else rate_table or estimated fallback).

### Proof
- Log proof: captured command help + scan outputs in this Daily.
- Files generated: `aiopt-output/{analysis.json,report.txt,cost-policy.json}`.

### Next action
- Finish T0 by adding a short note: what’s missing for v0.2 (install/doctor + wrapper/guard + scan as solution generator).
- Then start T1 (set IN_PROGRESS) with DoD check.

## [T1] install/doctor progress (proof)
- `npm run build` OK
- `node dist/cli.js install --force` OK (created aiopt/ + policies + usage.jsonl)
- `node dist/cli.js doctor` OK (checks + last5)

Created paths (sample run):
- aiopt/README.md
- aiopt/aiopt.config.json
- aiopt/policies/{routing.json,retry.json,output.json,context.json}
- aiopt/aiopt-wrapper.ts
- aiopt-output/usage.jsonl

---

## Runloop — 2026-02-07 18:24 KST
### Resume: aiopt-v02-T1 (install/doctor)
Smoke re-validate (fresh temp dir):
- Command: `node dist/cli.js install --force`
  - Proof: created `aiopt/README.md`, `aiopt/aiopt.config.json`, `aiopt/policies/*.json`, `aiopt/aiopt-wrapper.ts`, `aiopt-output/usage.jsonl`
- Command: `node dist/cli.js doctor`
  - Proof: doctor OK + printed last usage events

Proof logs:
- CLI help: `node dist/cli.js --help` (captured in terminal)
- Temp run dir: `/tmp/aiopt-test` (created & verified)

Next:
- Mark aiopt-v02-T1 DONE in TaskTracker with this Daily link.
- Move to aiopt-v02-T2 (Wrapper/guard).

### TaskTracker updates
- aiopt-v02-T1 -> DONE (100%)
- aiopt-v02-T2 -> IN_PROGRESS (0%)


## Runloop — 2026-02-07 18:56 KST (T2 proof fix)
Cause: wrapper template was generated as TS and had template-string escape bugs; runtime couldn't require it.
Alternative: rewrite install wrapper template to CommonJS `aiopt/aiopt-wrapper.js` (no TS deps) + fix newline escaping.

Smoke proof (local):
- `npm run build` OK
- `node dist/cli.js install --force` OK
- Demo: guardedCall x10 with 1 forced timeout => usage.jsonl lines=12, max_attempt=2, routed_from_count=3

Next: commit + push, then update TaskTracker T2.* DONE with commit SHA.

## Runloop — 2026-02-07 19:01 KST
### DONE: aiopt-v02-T2 (Wrapper guard proof fields)
Changes:
- Wrapper now accepts either normalized token fields or OpenAI-style `usage` and always logs required JSONL fields.
- Wrapper no longer hard-fails if `rates/rate_table.json` is missing in a fresh project (falls back to default rates).
- Install template README now includes wrapper usage snippet.

Proof:
- Commit: fc9bb75
- Build: `npm run build` (OK)
- Fresh dir smoke:
  - `node dist/cli.js install --force` (OK)
  - `node demo` calling `guardedCall` with `{ response: { usage: ... } }` wrote JSONL line with prompt/completion/total + cost
  - Sample tail (from /tmp/aiopt-wrap-test):
    - `{..."prompt_tokens":100,"completion_tokens":20,"total_tokens":120,"cost_usd":0.00018,...}`

### DONE: aiopt-v02-T5.1 (docs)
- Added repo doc: `aiopt/README.md` starting with required sentence + 5-min demo steps.

Proof:
- Commit: a4c962d

## [T3] scan(solution generator) proof — 2026-02-07 19:08 KST
Commands:
- `npm run build`
- `node dist/cli.js install --force`
- `node dist/cli.js scan`

DoD artifacts created:
- aiopt-output/analysis.json
- aiopt-output/report.json
- aiopt-output/report.md (includes WHAT TO CHANGE + file keys)
- aiopt-output/patches/README.md
- aiopt-output/patches/policies.updated.{routing,retry,output}.json

Console output (Top Fix 3):
1) Retry tuning
2) Output cap
3) Routing rule
Report path: aiopt-output/report.md

---

## runloop — 2026-02-07 19:09 KST

- TaskTracker: marked **aiopt-v02-T3** completed (solution generator).
- Fix: enforce required first sentence in install README template.

### Proof

**Git commits**
- c99d892 docs: enforce required first sentence in install README
- (T3 implementation proof) 5b89bc8 feat(v0.2): scan generates report.md + patches + Top Fix 3

**Commands / logs**
```bash
cd /mnt/c/cusorWS/openclaw-project/aiopt
npm run build
# -> tsup build OK (dist/cli.js)

rm -rf /tmp/aiopt-scan
node dist/cli.js scan --input samples/sample_usage.jsonl --out /tmp/aiopt-scan
# stdout:
# Top Fix 3:
# 1) Retry tuning (aiopt/policies/retry.json)
# 2) Output cap (aiopt/policies/output.json)
# 3) Routing rule (aiopt/policies/routing.json)
# Report: /tmp/aiopt-scan/report.md

ls -R /tmp/aiopt-scan
# -> analysis.json, cost-policy.json, report.json, report.md, report.txt, patches/*

cd /mnt/c/cusorWS/openclaw-project
tools/task.sh done aiopt-v02-T3 "[v0.2] T3 scan: solution generator" "DONE... Proof: 5b89bc8 (README sentence fix: c99d892)."
```

## [T4] Savings simulator refactor proof — 2026-02-07 19:13 KST
Changes:
- total_cost now includes retries as extra attempts: total = base_cost * (1 + retries)
- savings allocation is per-event with caps (no double counting): routing -> context -> retry
- global guard: estimated_savings_total <= total_cost always
- report.json/report.md include confidence + assumptions; >=90% savings triggers warning

Proof logs:
- `npm run build` OK
- Retry test input `/tmp/retrytest.jsonl` => { total: 0.19, savings: 0.05, ok: true, retry_waste: 0.03 }

## [T3] hardening pass — 2026-02-07 19:17 KST
Problem: scan expected input schema (input_tokens/output_tokens/feature_tag/retries), but wrapper writes usage schema (prompt_tokens/completion_tokens/endpoint/attempt/cost_usd). This caused total_cost=0 and misleading reports.
Fix: src/io.ts normalizeEvent now supports BOTH schemas:
- input_tokens <- input_tokens || prompt_tokens
- output_tokens <- output_tokens || completion_tokens
- feature_tag <- feature_tag || meta.feature_tag || endpoint
- retries <- retries || (attempt-1)
- billed_cost <- billed_cost || cost_usd

Proof smoke:
- install --force, guardedCall x10, then scan default input
- analysis.json total_cost=0.17, savings=0.01, savings<=total => true
