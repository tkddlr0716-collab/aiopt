name: ci

on:
  push:
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

      # v0.2 scenario: install -> doctor -> fake usage -> scan
      - run: rm -rf .ci-smoke && mkdir -p .ci-smoke
      - run: node ../dist/cli.js install --force
        working-directory: .ci-smoke
      - run: node ../dist/cli.js doctor
        working-directory: .ci-smoke
      - run: node -e "const fs=require('fs');fs.mkdirSync('aiopt-output',{recursive:true});for(let i=0;i<10;i++)fs.appendFileSync('aiopt-output/usage.jsonl',JSON.stringify({ts:new Date().toISOString(),request_id:'r'+i,trace_id:'t'+i,attempt:1,status:'ok',error_code:null,provider:'openai',model:'gpt-5-mini',endpoint:'responses.create',prompt_tokens:1000,completion_tokens:200,total_tokens:1200,cost_usd:0.01,latency_ms:123,meta:{feature_tag:(i%2?'summarize':'coding')}})+'\\n');"
        working-directory: .ci-smoke
      - run: node ../dist/cli.js scan
        working-directory: .ci-smoke
      - run: test -f ./aiopt-output/report.md
        working-directory: .ci-smoke
      - run: test -f ./aiopt-output/report.json
        working-directory: .ci-smoke
      - run: grep -q "Top Fix 3" ./aiopt-output/report.md
        working-directory: .ci-smoke
      - run: test -f ./aiopt-output/patches/README.md
        working-directory: .ci-smoke
      - run: test -f ./aiopt-output/patches/policies.updated.retry.json
        working-directory: .ci-smoke

      # guardrail (exit codes 0/2/3)
      - name: Guard (non-blocking example + summary)
        working-directory: .ci-smoke
        run: |
          set +e
          out=$(node ../dist/cli.js guard --input ./aiopt-output/usage.jsonl --context-mult 1.2)
          code=$?

          echo "guard_exit=$code"
          echo "AIOPT_GUARD_EXIT=$code" >> "$GITHUB_ENV"
          printf "%s" "$out" > ./aiopt-output/guard.txt

          echo "## AIOpt Guardrail" >> "$GITHUB_STEP_SUMMARY"
          if [ "$code" = "0" ]; then
            echo "âœ… OK" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$code" = "2" ]; then
            echo "âš ï¸ WARN" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ðŸ›‘ FAIL" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "\n\`\`\`\n$out\n\`\`\`\n" >> "$GITHUB_STEP_SUMMARY"

          # allow 0 or 2 here
          test "$code" = "0" -o "$code" = "2"

      - name: Guard tests (fixtures)
        run: npm run test:guard

      - name: Guard (blocking example: expect FAIL=3)
        working-directory: .ci-smoke
        run: |
          set +e
          node ../dist/cli.js guard --input ./aiopt-output/usage.jsonl --model gpt-5.2 --context-mult 50
          code=$?
          echo "blocking_example_exit=$code"
          # This is how you would block merges:
          #   node ../dist/cli.js guard ...   (no set +e)
          # Here we assert the command would return 3.
          test "$code" = "3"

      - name: PR comment (guardrail)
        if: github.event_name == 'pull_request' && env.AIOPT_GUARD_EXIT != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('.ci-smoke/aiopt-output/guard.txt','utf8');
            const pr = context.payload.pull_request;
            if (!pr) return;
            const header = `## AIOpt Guardrail (${process.env.AIOPT_GUARD_EXIT})`;
            const msg = `${header}\n\n\`\`\`\n${body}\n\`\`\``;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: msg
            });


