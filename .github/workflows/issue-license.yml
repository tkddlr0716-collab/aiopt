name: issue-license

on:
  workflow_dispatch:
    inputs:
      sub:
        description: 'Customer identifier (email or order id)'
        required: true
        type: string
      plan:
        description: 'plan (pro|team|trial)'
        required: true
        default: 'pro'
        type: choice
        options:
          - pro
          - team
          - trial
      months:
        description: 'validity months (e.g., 3 or 12)'
        required: true
        default: '3'
        type: string

jobs:
  issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Issue license
        env:
          RSA_PRIVKEY_PEM: ${{ secrets.RSA_PRIVKEY_PEM }}
          SUB: ${{ inputs.sub }}
          PLAN: ${{ inputs.plan }}
          MONTHS: ${{ inputs.months }}
        run: |
          test -n "$RSA_PRIVKEY_PEM" || (echo 'Missing secret: RSA_PRIVKEY_PEM' && exit 1)
          mkdir -p .out
          printf "%s" "$RSA_PRIVKEY_PEM" > .out/private.pem
          node scripts/issue-license.js --priv .out/private.pem --sub "$SUB" --plan "$PLAN" --months "$MONTHS" > .out/license.txt
          echo "Issued for sub=$SUB plan=$PLAN months=$MONTHS"
          wc -c .out/license.txt

      - name: Upload license artifact
        uses: actions/upload-artifact@v4
        with:
          name: aiopt-license
          path: .out/license.txt
